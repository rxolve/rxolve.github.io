---
title: "WITH, EXCEPT, UNION을 조합한 데이터 삽입 쿼리"
date: "240801"
tags: ["JavaScript"]
---

```SQL
WITH missing_sources AS (
    SELECT u.id AS user_id,
           unnest(ARRAY['EN', 'KO', 'MA']) AS subject
    FROM users u
    EXCEPT
    SELECT user_id, subject
    FROM user_sources
),
     source_data AS (
         SELECT 'EN' AS subject, 3311642552309909477 AS source_id, 'workbook' AS source_type
         UNION ALL SELECT 'EN', 3011242277373740924, 'workbook'
         UNION ALL SELECT 'KO', 3402984824854545428, 'workbook'
         UNION ALL SELECT 'KO', 3307370955759683557, 'workbook'
         UNION ALL SELECT 'MA', 3305971174210536874, 'textbook'
         UNION ALL SELECT 'MA', 3305971174210536888, 'textbook'
     )
INSERT INTO user_sources (user_id, subject, source_id, source_type)
SELECT
    ms.user_id,
    ms.subject,
    sd.source_id,
    sd.source_type
FROM missing_sources ms
         JOIN source_data sd ON ms.subject = sd.subject;
```
