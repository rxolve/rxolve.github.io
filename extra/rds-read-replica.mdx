---
title: "TypeORM으로 AWS RDS 쿼리 분산 시키기"
date: "240620"
tags: ["AWS", "RDS", "NestJS"]
---

- 서비스가 커짐에 따라 RDS의 CPU 사용량은 나날이 증가했습니다.
  - 해결하기 위해 쿼리개선 작업을 진행했지만, 한계가 찾아왔습니다.
- RDS의 스케일업이 결정되었고, 작업을 진행했는데 다운타임이 5분 정도 발생하는 문제가 있었습니다. RDS 인스턴스가 한 대이기 때문에 발생하는 문제였습니다.
- CPU 사용량을 분산시키고 무중단 배포를 위해 Read Replica를 생성하고, TypeORM을 통해 읽기 전용 쿼리를 슬레이브로 보내는 방식을 적용했습니다.

### 1. AWS RDS Read Replica 생성

- 먼저 AWS 콘솔에서 Read Replica를 생성해야 합니다. 이는 이미 생성된 RDS 인스턴스의 읽기 전용 복제본입니다.

1. AWS RDS 콘솔에 로그인합니다.
2. 원본 RDS 인스턴스를 선택합니다.
3. 작업(Actions) 메뉴에서 "Create read replica"를 선택합니다.
4. 필요한 설정을 완료하고 "Create read replica"를 클릭합니다.

### 2. TypeORM 설정 파일 변경

- TypeORM 설정 파일을 수정하여 읽기 전용 연결을 설정합니다.
  - `replication` 설정을 통해 마스터와 슬레이브를 구분합니다.

```ts
{
  type: 'postgres',
  replication: {
    master: {
      host: 'POSTGRESQL_HOST',
      port: 'POSTGRESQL_PORT',
      username: 'POSTGRESQL_USER',
      password: 'POSTGRESQL_PASSWORD',
      database: 'POSTGRESQL_DATABASE',
    },
    slaves: [
      {
        host: 'POSTGRESQL_RO_HOST',
        port: 'POSTGRESQL_PORT',
        username: 'POSTGRESQL_USER',
        password: 'POSTGRESQL_PASSWORD',
        database: 'POSTGRESQL_DATABASE',
      },
    ],
  },
  entities: [__dirname + '/entities/*.entity{.ts,.js}'],
  synchronize: false,
  logging: true,
};
```

### 3. 코드에서 읽기 전용 쿼리 실행

- TypeORM은 `replication` 설정을 통해 자동으로 읽기 전용 쿼리를 슬레이브로 보냅니다.
- 별도의 설정 없이도 `find` 같은 읽기 전용 쿼리는 슬레이브로 라우팅됩니다.
