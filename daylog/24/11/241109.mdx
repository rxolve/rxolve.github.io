---
title: "다중 인스턴스 환경에서 세션 공유"
date: "241109"
tags: ["AWS", "AdminJS"]
---

AdminJS를 운영하다 보면, 단일 서버에서는 크게 문제가 없던 세션 관리가 다중 인스턴스(또는 스케일 아웃) 환경에서는 여러 가지 난관에 부딪히게 됩니다.  
왜 세션 공유가 중요한지, 그리고 이를 해결하기 위한 대표적인 방법들을 살펴보겠습니다.

## 왜 다중 인스턴스 환경에서 세션 공유가 필요할까?

HTTP는 본질적으로 Stateless(무상태) 프로토콜입니다.  
즉, 클라이언트의 각 요청은 독립적으로 처리되기 때문에 로그인이나 사용자별 설정 등 상태 정보를 유지하려면 세션을 사용해야 합니다.  
단일 서버에서는 메모리에 저장하는 방식으로 충분하지만, 로드 밸런서를 통해 여러 서버(인스턴스)로 요청이 분산되는 환경에서는 한 서버에 저장한 세션 정보가 다른 서버에 존재하지 않아 문제가 발생합니다.

예를 들어, 사용자가 로그인 후 첫 요청은 서버 A에서 세션을 생성하지만 이후 요청이 서버 B로 전달되면, 서버 B에는 해당 세션 정보가 없으므로 다시 인증을 요구하게 됩니다.  
이러한 문제를 해결하려면 모든 인스턴스가 세션 정보를 공유할 수 있어야 합니다.

## 세션 공유를 위한 대표적인 해결 방안

다중 인스턴스 환경에서 세션 공유를 구현하는 방법은 크게 세 가지로 나눌 수 있습니다.

#### Sticky Session

Sticky Session은 로드 밸런서가 특정 사용자의 요청을 항상 처음 세션을 생성한 서버로 전달하도록 하는 방식입니다.  
즉, 클라이언트의 쿠키에 저장된 정보를 기반으로 한 서버로 요청을 고정시켜, 해당 서버의 메모리에 저장된 세션을 재사용하게 됩니다.

장점:

- 세션 공유를 위한 별도의 인프라 없이도 문제 해결 가능
- 구현이 간단

단점:

- 특정 서버에 트래픽이 몰리면 부하 집중
- 장애 발생 시 해당 서버에 연결된 사용자 모두가 영향을 받음

> Sticky Session 방식은 단기적 해결책일 수 있으나, 가용성과 확장성을 고려한다면 한계가 있습니다.

#### Session Clustering

세션 클러스터링은 WAS(예: Tomcat)에서 제공하는 기능으로, 한 서버에서 생성된 세션 정보를 다른 서버와 실시간으로 복제하는 방식입니다.  
즉, 사용자의 세션이 여러 서버에 복제되어 저장되므로 어느 서버로 요청이 전달되더라도 동일한 세션 데이터를 참조할 수 있습니다.

장점:

- 어느 서버에 접속하더라도 세션 일관성을 유지
- 장애 발생 시 다른 서버가 즉시 대응 가능

단점:

- 서버 수가 늘어나면 복제에 따른 메모리 및 네트워크 부하 증가
- 대규모 클러스터 환경에서는 성능 한계가 존재
  > Tomcat의 all-to-all 세션 복제 방식은 소규모 클러스터에 적합하다는 점에 유의해야 합니다.

#### 외부 세션 스토리지 사용 (Redis 등)

가장 보편적이고 확장성 있는 방법은 외부 세션 저장소(예: Redis, Memcached)를 도입하는 것입니다.  
이 경우, 각 인스턴스는 메모리 내에 세션을 저장하는 대신, 중앙집중화된 저장소에 접근하여 세션 정보를 읽고 씁니다.

예시 코드 (Node.js Express + Redis):

```javascript
const session = require("express-session");
const RedisStore = require("connect-redis")(session);
const redis = require("redis");

const redisClient = redis.createClient({
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT,
  // 인증 정보 필요 시 추가 설정
});

app.use(
  session({
    store: new RedisStore({ client: redisClient }),
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: { secure: process.env.NODE_ENV === "production" },
  })
);
```

장점:

- 모든 서버가 중앙 저장소를 참조하므로 세션 불일치 문제 완벽 해결
- 확장성과 고가용성 확보 (Replication 및 클러스터링 적용 가능)

단점:

- 별도의 인프라 구축 및 운영 필요
- 네트워크 지연 등 외부 저장소 특유의 이슈 발생 가능

> Redis를 사용하면 Spring, Node.js 등 다양한 프레임워크와 손쉽게 연동할 수 있어 많은 프로젝트에서 선호됩니다.

## 각 방식 선택 시 고려 사항

- 트래픽 규모: 소규모라면 Sticky Session이나 세션 클러스터링도 고려할 수 있지만, 대규모 트래픽 환경에서는 외부 세션 저장소가 더 안전합니다.
- 가용성: 특정 인스턴스에 의존하지 않고, 중앙 저장소의 Replication 설정 등을 통해 장애에 대비해야 합니다.
- 운영 복잡도: 추가 인프라 구축 및 모니터링이 필요하므로, 팀의 운영 능력을 고려해 선택해야 합니다.

## 결론

다중 인스턴스 환경에서 세션 공유 문제는 단순히 개발 측면뿐만 아니라 운영 및 확장성 측면에서도 매우 중요한 이슈입니다.  
일반적으로 외부 세션 저장소(특히 Redis)를 사용하는 방식이 가장 널리 채택되고 있으며, 안정성과 확장성을 모두 확보할 수 있는 방법입니다.  
물론, 각 방식마다 장단점이 있으므로 서비스 특성과 트래픽 규모에 따라 최적의 방법을 선택하는 것이 중요합니다.  
저는 사내에서 사용하는 어드민이기에 Sticky Session을 설정할 예정입니다.
