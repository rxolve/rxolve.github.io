---
title: "자바스크립트 이벤트 루프"
date: "240926"
tags: ["JavaScript"]
---

자바스크립트의 이벤트 루프는 자바스크립트가 싱글 스레드로 비동기 작업을 할 수 있게 해주는 중요한 개념이기에 정리해보았습니다.

이를 위해서는 콜 스택, 이벤트 큐, 그리고 이벤트 루프 간의 상호작용을 알아야 합니다.

## 콜 스택

- 자바스크립트는 싱글 스레드로 동작하기 때문에 한 번에 하나의 작업만 처리할 수 있습니다.
- 현재 실행 중인 함수나 코드 블록을 `콜 스택`이라는 메모리 공간에 쌓고, 작업이 끝나면 스택에서 제거합니다.
- 예를 들어, 함수 `a`가 함수 `b`를 호출하면, `a`가 스택에 쌓인 상태에서 `b`가 스택의 최상위에 추가됩니다.
  - `b`의 실행이 끝나면 스택에서 제거됩니다.
  - 다시 `a`가 실행됩니다.

## 이벤트 큐(태스크 큐)

- 비동기 작업(예: 타이머, 네트워크 요청, DOM 이벤트 등)이 완료되면 그 콜백 함수는 `이벤트 큐`에 들어갑니다.
- 이벤트 큐에 쌓인 콜백 함수들은 콜 스택이 비어 있을 때, 즉 현재 실행 중인 동기 작업이 모두 끝났을 때 실행될 준비가 됩니다.

## 이벤트 루프

- 이벤트 루프는 끊임없이 콜 스택과 이벤트 큐를 모니터링합니다.
- 콜 스택이 비어 있으면, 이벤트 큐에서 대기 중인 콜백을 콜 스택으로 옮겨와 실행합니다.
- 이를 통해 자바스크립트는 동기 작업이 끝난 후에도 비동기 콜백을 처리할 수 있게 됩니다.

## 매크로 태스크와 마이크로 태스크

이벤트 루프의 실행 순서를 정확히 이해하려면, 작업의 종류를 매크로 태스크와 마이크로 태스크로 구분해야 합니다.

#### 매크로 태스크

- 타이머(`setTimeout`, `setInterval`), I/O 작업, 이벤트 핸들러 등이 매크로 태스크에 해당합니다.
- 매크로 태스크는 콜 스택이 비어 있을 때 이벤트 큐에서 하나씩 꺼내와 실행됩니다.

#### 마이크로 태스크

- 프로미스의 `then`, `catch`, `finally`가 마이크로 태스크에 해당합니다.
- 마이크로 태스크는 매크로 태스크보다 우선적으로 실행됩니다.
- 즉, 매크로 태스크가 끝난 후, 새로운 매크로 태스크를 처리하기 전에 마이크로 태스크 큐에 쌓인 작업들을 모두 처리합니다.

## 이벤트 루프의 동작 예시

```javascript
console.log("start");

setTimeout(() => {
  console.log("setTimeout");
}, 0);

Promise.resolve().then(() => {
  console.log("promise");
});

console.log("end");
```

1. `console.log('start')`가 콜 스택에 쌓여 실행됩니다.
2. `setTimeout`은 매크로 태스크로 이벤트 큐에 콜백이 등록됩니다.
3. `Promise.resolve().then`의 콜백은 마이크로 태스크로 마이크로 태스크 큐에 등록됩니다.
4. `console.log('end')`가 콜 스택에 쌓여 실행됩니다.
5. 콜 스택이 비게 되면, 이벤트 루프는 먼저 마이크로 태스크 큐를 확인하여 `promise` 메시지를 출력합니다.
6. 마이크로 태스크 큐가 비어 있으면, 매크로 태스크 큐에서 `setTimeout` 콜백을 가져와 실행하여 `setTimeout` 메시지를 출력합니다.

이렇게 이벤트 루프는 자바스크립트가 동기적으로 실행되는 동안에도 비동기 작업을 효율적으로 관리하여, 사용자 경험이 끊기지 않게 해줍니다.

## 다이어그램

<Mermaid chart={`
graph TD
    A[코드 실행] --> B[콜 스택]
    B --> C{스택이 비었는가?}
    C -->|Yes| D[이벤트 루프]
    C -->|No| B
    D --> E{마이크로태스크 큐에 태스크가 있는가?}
    E -->|Yes| F[마이크로태스크 실행]
    F --> D
    E -->|No| G{매크로태스크 큐에 태스크가 있는가?}
    G -->|Yes| H[매크로태스크 실행]
    H --> D
    G -->|No| D

    I[Web API / C++ API] --> J[태스크 큐]
    K[Promise 처리] --> L[마이크로태스크 큐]

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style D fill:#bfb,stroke:#333,stroke-width:2px
    style I fill:#fbb,stroke:#333,stroke-width:2px
    style J fill:#fbf,stroke:#333,stroke-width:2px
    style L fill:#bff,stroke:#333,stroke-width:2px
    `}

/>
