---
title: "NestJS ìˆœí™˜ ì°¸ì¡°ì™€ì˜ ì‚¬íˆ¬"
date: "241024"
tags: ["NestJS"]
---

<img
  src="https://images.pexels.com/photos/39656/staircase-spiral-architecture-interior-39656.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
  width={700}
  alt="spiral staircase"
/>

ì˜¤ëŠ˜ë„ ìˆœí™˜ì°¸ì¡°ë¥¼ í•´ê²°í•˜ëŠ”ë° ë§ì€ ì‹œê°„ì„ ìŸì•˜ìŠµë‹ˆë‹¤.

NestJSì—ì„œ ìˆœí™˜ ì°¸ì¡° ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤.

## ìˆœí™˜ ì°¸ì¡°ëŠ” ì™œ ìƒê¸°ë‚˜ìš”?

Userì™€ Post ì—”í‹°í‹°ë¡œ ìˆœí™˜ ì°¸ì¡°ì˜ ì˜ˆì‹œë¥¼ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.

```typescript
@Injectable()
export class UserService {
  constructor(private postService: PostService) {}

  async getUser(id: string) {
    const user = await this.userRepo.findOne(id);
    const posts = await this.postService.getPostsByUser(id);
    return { ...user, posts };
  }
}

@Injectable()
export class PostService {
  constructor(private userService: UserService) {}

  async getPost(id: string) {
    const post = await this.postRepo.findOne(id);
    const user = await this.userService.getUser(post.userId);
    return { ...post, user };
  }
}
```

ì´ë ‡ê²Œ ì§œê³  ë‚˜ë©´ ìˆœí™˜ ì°¸ì¡° ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

## ìˆœí™˜ ì°¸ì¡° ì˜ˆë°©í•˜ê¸°

ìˆœí™˜ ì°¸ì¡°ëŠ” ì˜ˆë°©ì´ ì œì¼ ì¤‘ìš”í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•œ ëª‡ ê°€ì§€ íŒ¨í„´ì„ ê³µìœ ë“œë¦½ë‹ˆë‹¤.

#### DDD ê´€ì ìœ¼ë¡œ ì ‘ê·¼í•˜ê¸°

```typescript
// ğŸ‘ ì´ë ‡ê²Œ í•˜ë©´ ìˆœí™˜ ì°¸ì¡° ìœ„í—˜ì´ ë†’ì•„ìš”
@Injectable()
export class UserService {
  async getFullUserInfo(id: string) {
    // ì—¬ê¸°ì €ê¸°ì„œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ...
  }
}

// ğŸ‘ ì´ë ‡ê²Œ ë„ë©”ì¸ ê²½ê³„ë¥¼ ëª…í™•íˆ!
@Injectable()
export class UserDomainService {
  async getUserCore(id: string) {
    return this.userRepo.findOne(id);
  }
}

@Injectable()
export class UserApplicationService {
  constructor(
    private userDomainService: UserDomainService,
    private postQueryService: PostQueryService
  ) {}
}
```

#### ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ í™œìš©í•˜ê¸°

ìˆœí™˜ ì°¸ì¡°ê°€ ìì£¼ ë°œìƒí•˜ëŠ” ë¶€ë¶„ì€ ì´ë²¤íŠ¸ë¡œ ì „í™˜í•˜ëŠ” ê²ƒë„ ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤.

```typescript
// ì´ë²¤íŠ¸ ì •ì˜
export class UserCreatedEvent {
  constructor(public readonly userId: string) {}
}

// ì´ë²¤íŠ¸ ë°œí–‰
@Injectable()
export class UserService {
  constructor(private eventEmitter: EventEmitter2) {}

  async createUser() {
    // ... ìœ ì € ìƒì„± ë¡œì§
    this.eventEmitter.emit("user.created", new UserCreatedEvent(user.id));
  }
}

// ì´ë²¤íŠ¸ êµ¬ë…
@Injectable()
export class PostService {
  @OnEvent("user.created")
  handleUserCreated(event: UserCreatedEvent) {
    // í•„ìš”í•œ ì²˜ë¦¬
  }
}
```

#### ì¿¼ë¦¬ ìµœì í™”ë¡œ ìˆœí™˜ ì°¸ì¡° ì—†ì• ê¸°

ê°€ë”ì€ ë‹¨ìˆœíˆ ì¿¼ë¦¬ë¥¼ ìµœì í™”í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ìˆœí™˜ ì°¸ì¡°ë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
// ğŸ‘ ì´ë ‡ê²Œ í•˜ë©´ N+1 ë¬¸ì œë„ ìƒê¸°ê³  ìˆœí™˜ ì°¸ì¡° ìœ„í—˜ë„ ë†’ì•„ìš”
async getUser(id: string) {
  const user = await this.userRepo.findOne(id);
  const posts = await this.postService.getPostsByUser(id);
  return { ...user, posts };
}

// ğŸ‘ ì´ë ‡ê²Œ í•œ ë²ˆì— ê°€ì ¸ì˜¤ë©´ ê¹”ë”!
async getUser(id: string) {
  return this.userRepo
    .createQueryBuilder('user')
    .leftJoinAndSelect('user.posts', 'posts')
    .where('user.id = :id', { id })
    .getOne();
}
```

## ê·¸ë˜ë„ ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí–ˆë‹¤ë©´?

ë•Œë¡œëŠ” ì–´ì©” ìˆ˜ ì—†ì´ ìˆœí™˜ ì°¸ì¡°ê°€ í•„ìš”í•œ ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ´ ë•ŒëŠ”

#### forwardRef() ì‚¬ìš©í•˜ê¸°

```typescript
@Injectable()
export class UserService {
  constructor(
    @Inject(forwardRef(() => PostService))
    private postService: PostService
  ) {}
}
```

#### ê³µí†µ ì¸í„°í˜ì´ìŠ¤ ì¶”ì¶œí•˜ê¸°

```typescript
interface IUserData {
  id: string;
  name: string;
}

@Injectable()
export class UserService {
  async getBasicUserInfo(id: string): Promise<IUserData> {
    // ìµœì†Œí•œì˜ ì •ë³´ë§Œ ë°˜í™˜
  }
}
```

## ìˆœí™˜ ì°¸ì¡° ê²€ì¦í•˜ê¸°

1. ëª¨ë“ˆ ì˜ì¡´ì„± ê·¸ë˜í”„ ê·¸ë¦¬ê¸°

   - ì˜ì¡´ì„±ì„ ì‹œê°í™”í•˜ë©´ ìˆœí™˜ ì°¸ì¡°ë¥¼ ì‰½ê²Œ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - ì—°ìŠµì¥ í˜¹ì€ Mermaid ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.

2. í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ê²€ì¦í•˜ê¸°

```typescript
describe("Circular Dependency Check", () => {
  it("should initialize application without circular dependency errors", async () => {
    const app = await NestFactory.create(AppModule);
    expect(app).toBeDefined();
    await app.close();
  });
});
```

## ì •ë¦¬í•˜ë©°

ìˆœí™˜ ì°¸ì¡°ëŠ” í”¼í•  ìˆ˜ ìˆë‹¤ë©´ í”¼í•˜ëŠ” ê²Œ ì¢‹ì§€ë§Œ, ë•Œë¡œëŠ” ë¶ˆê°€í”¼í•œ ê²½ìš°ë„ ìˆìŠµë‹ˆë‹¤.

80%ëŠ” ì„¤ê³„ ë‹¨ê³„ì—ì„œ ì˜ˆë°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‚˜ë¨¸ì§€ 20%ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ë³µì¡í•´ì§€ë©´ì„œ ë°œìƒí•˜ëŠ”ë°, ì´ë•ŒëŠ” ìœ„ì—ì„œ ì„¤ëª…í•œ í•´ê²°ì±…ë“¤ì„ ì ì ˆíˆ ì¡°í•©í•´ì„œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.
