---
title: "세션 점유 쿼리 종료"
date: "250407"
tags: ["RDS"]
---

운영 중에 특정 쿼리가 너무 오래 실행되어 세션을 점유하는 상황은 데이터베이스 성능 저하와 애플리케이션 응답 지연의 주요 원인이 될 수 있습니다.  
PostgreSQL에서는 `pg_stat_activity` 뷰를 통해 실행 중인 쿼리와 세션 상태를 모니터링하고, 필요에 따라 `pg_terminate_backend` 함수를 사용해 문제 세션을 종료할 수 있습니다.

## 실행 중인 쿼리 모니터링

#### pg_stat_activity

`pg_stat_activity`는 PostgreSQL에서 현재 활성화된 모든 세션과 그 상태, 실행 중인 쿼리의 시작 시간 등 유용한 정보를 제공하는 시스템 뷰입니다.  
이 뷰를 활용하면 어떤 쿼리가 오랜 시간 실행되고 있는지, 그리고 어떤 세션이 리소스를 많이 점유하고 있는지 쉽게 확인할 수 있습니다.

#### 오래 실행되는 쿼리 확인하기

아래 쿼리는 현재 'active' 상태로 실행 중이며, 실행 시간이 5분 이상인 쿼리들을 찾아내는 예제입니다.

```sql
SELECT
  pid,
  usename,
  datname,
  query,
  state,
  now() - query_start AS duration
FROM pg_stat_activity
WHERE state = 'active'
  AND now() - query_start > interval '5 minutes'
ORDER BY duration DESC;
```

이 결과를 통해 특정 세션의 PID와 실행 시간을 확인할 수 있으며, 어느 쿼리가 문제를 일으키고 있는지 쉽게 파악할 수 있습니다.

## 문제 세션 종료하기

#### 왜 세션을 종료해야 할까?

오래 실행되는 쿼리가 세션을 점유하면, 다른 사용자나 애플리케이션에서 해당 데이터베이스에 접속할 때 응답 지연 및 리소스 경합 문제가 발생할 수 있습니다.  
이때 해당 쿼리를 강제로 종료시켜야 하는데, PostgreSQL에서는 두 가지 방법을 제공합니다.

- pg_cancel_backend(pid): 현재 실행 중인 쿼리만 취소하고 세션은 유지합니다. (연결은 끊지 않음)
- pg_terminate_backend(pid): 세션 전체를 강제로 종료합니다.

여기서는 문제가 되는 세션을 완전히 종료하는 방법인 pg_terminate_backend에 대해 집중해 보겠습니다.

#### pg_terminate_backend 사용 예제

예를 들어, `pg_stat_activity`를 통해 PID 8121번 세션이 오랜 시간 실행 중임을 확인했다고 가정합니다.  
해당 세션을 종료하기 위해서는 아래와 같이 명령을 실행합니다.

```sql
SELECT pg_terminate_backend(8121);
```

이 명령은 해당 PID의 세션을 강제로 종료합니다. 사용 후에는 해당 세션과 관련된 모든 트랜잭션이 롤백되며, 연결이 끊어집니다.

> 주의:
>
> - 권한: 이 함수를 실행하려면 해당 세션의 소유자이거나, 적절한 권한(예: superuser 또는 rds_superuser 권한)이 필요합니다.
> - 데이터 정합성: 세션 종료 시 진행 중인 트랜잭션이 롤백되므로, 데이터 정합성이나 애플리케이션의 후속 처리를 고려해 신중하게 사용해야 합니다.

---

## 운영에서의 활용 방안

#### 모니터링 자동화

직접 SQL 클라이언트에서 수동으로 쿼리를 확인하는 것도 좋지만, 운영 환경에서는 주기적으로 자동화된 모니터링과 알림 시스템을 구성하는 것이 효과적입니다.

- CloudWatch와 Lambda 연계:  
  AWS Lambda 함수를 사용해 일정 주기로 `pg_stat_activity`를 조회하고, 실행 시간이 일정 기준(예: 5분)을 초과하는 쿼리가 발견되면 SNS를 통해 알림을 전송하거나, 자동으로 `pg_terminate_backend`를 호출하는 스크립트를 실행할 수 있습니다.
- Performance Insights 활용:  
  PostgreSQL의 Performance Insights 기능을 활용하면, 쿼리 성능 분석과 병목 현상을 보다 직관적으로 파악할 수 있습니다.

#### 로그 기록 및 사후 분석

세션 종료 작업을 수행할 때는 종료된 세션의 PID, 종료 시각, 실행 쿼리 등의 정보를 로그에 기록해두고, 사후 분석을 통해 문제의 근본 원인(예: 인덱스 부재, 쿼리 최적화 미흡 등)을 파악하는 것이 좋습니다.

## 정리

PostgreSQL 환경에서 오랫동안 실행되어 세션을 점유하는 쿼리를 효과적으로 관리하기 위해서는,

1. pg_stat_activity를 통해 실행 중인 쿼리와 세션 상태를 주기적으로 모니터링하고,
2. pg_terminate_backend를 활용해 필요 시 해당 세션을 강제로 종료하는 방법이 있습니다.

운영 상황에 따라 자동화 도구(예: Lambda, CloudWatch)와 결합하면, 문제 발생 시 신속하게 대응할 수 있으며 장기적으로 데이터베이스 성능과 안정성을 확보할 수 있습니다.  
문제 상황에 맞는 적절한 조치와 함께 쿼리 최적화 및 인덱스 적용 등 근본적인 성능 개선 작업도 함께 진행하시기 바랍니다.
